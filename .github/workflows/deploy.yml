name: Build, Push to Private Registry and Deploy with Helm

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  REGISTRY: 192.168.1.11:30500
  IMAGE_NAME: django-app
  K8S_NAMESPACE: django-app
  HELM_RELEASE: "django-app-production"

jobs:
  build-and-push:
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v4
      - name: Log in to private registry
        run: |
          sudo docker login ${{ env.REGISTRY }} -u adminuser -p passwd123
      - name: Build Docker image
        run: |
          sudo docker build -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest .
      - name: Push image
        run: |
          sudo docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
  deploy-with-helm:
    needs: build-and-push
    runs-on: self-hosted
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4
      - name: Set up Kubeconfig
        uses: azure/k8s-set-context@v3
        with:
          kubeconfig: ${{ secrets.KUBE_CONFIG }}
      - name: Deploy with Helm
        run: |
          helm upgrade --install ${{ env.HELM_RELEASE }} ./helm \
            --namespace ${{ env.K8S_NAMESPACE }} \
            --set image.repository=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }} \
            --set image.tag=latest \
            --set app.replicas=6 \
            --set postgresql.image.tag=latest \
            --reuse-values \
            --create-namespace \
            --wait \
            --timeout 300s
          helm list --namespace ${{ env.K8S_NAMESPACE }}
          kubectl get pods,svc,ingress -n ${{ env.K8S_NAMESPACE }}
      - name: Run database migrations
        run: |
          POD_NAME=$(kubectl get pods -n ${{ env.K8S_NAMESPACE }} -l "app.kubernetes.io/name=django-app" -o jsonpath='{.items[0].metadata.name}')
          kubectl exec -n ${{ env.K8S_NAMESPACE }} "$POD_NAME" -- python manage.py migrate
          kubectl exec -n ${{ env.K8S_NAMESPACE }} "$POD_NAME" -- python manage.py collectstatic --noinput
  smoke-test:
    needs: deploy-with-helm
    runs-on: self-hosted
    steps:
      - name: Check application health
        run: |
          APP_URL=$(kubectl get ingress -n ${{ env.K8S_NAMESPACE }} -o jsonpath='{.items[0].spec.rules[0].host}')
          curl -f http://$APP_URL/health/
          curl -f http://$APP_URL/metrics/
